<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warden Worker - Bitwarden å…¼å®¹æœåŠ¡å™¨</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 2rem 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }

        .container {
            text-align: center;
            background: white;
            padding: 2.5rem;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            max-width: 700px;
            width: 100%;
            margin-bottom: 2rem;
        }

        h1 {
            color: #667eea;
            margin-bottom: 0.5rem;
            font-size: 2rem;
            font-weight: 700;
        }

        .subtitle {
            color: #888;
            margin-bottom: 2rem;
            line-height: 1.6;
            font-size: 0.95rem;
        }

        .section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 12px;
            margin-top: 1.5rem;
            text-align: left;
            border: 1px solid #e9ecef;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title::before {
            content: "ğŸ”";
            font-size: 1.2rem;
        }

        .section-desc {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #0d47a1;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #856404;
        }

        .success-box {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #155724;
        }

        .form-group {
            margin-top: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            font-size: 0.95rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            font-size: 0.95rem;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
            resize: vertical;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.85rem 2rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #868e96 0%, #495057 100%);
        }

        .btn-secondary:hover {
            box-shadow: 0 4px 12px rgba(73, 80, 87, 0.4);
        }

        .btn-group {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .result {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 8px;
            background: #f8f9fa;
            white-space: pre-wrap;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;
            font-size: 0.85rem;
            text-align: left;
            border: 1px solid #dee2e6;
            display: none;
        }

        .result.show {
            display: block;
        }

        .qr-container {
            display: flex;
            justify-content: center;
            margin-top: 0.75rem;
        }

        .qr-image {
            width: 200px;
            height: 200px;
            background: white;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            padding: 0.5rem;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e9ecef;
            overflow-x: auto;
            overflow-y: hidden;
            flex-wrap: nowrap;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #667eea #f8f9fa;
        }

        .tabs::-webkit-scrollbar {
            height: 6px;
        }

        .tabs::-webkit-scrollbar-track {
            background: #f8f9fa;
            border-radius: 3px;
        }

        .tabs::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 3px;
        }

        .tabs::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: #6c757d;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .tab:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .footer {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            text-align: center;
            margin-top: 1rem;
        }

        @media (max-width: 640px) {
            .container {
                padding: 1.5rem;
            }

            h1 {
                font-size: 1.5rem;
            }

            .tab {
                padding: 0.6rem 1rem;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ” Warden Worker</h1>
    <div class="subtitle">
        è¿è¡Œåœ¨ Cloudflare Workers ä¸Šçš„ Bitwarden å…¼å®¹æœåŠ¡å™¨<br>
        å¼€æºã€å®‰å…¨ã€å¿«é€Ÿã€æ˜“ç”¨çš„å¯†ç ç®¡ç†è§£å†³æ–¹æ¡ˆ
    </div>

    <!-- TAB å¯¼èˆª -->
    <div class="tabs">
        <button class="tab active" data-tab="register">ğŸ‘¤ ç”¨æˆ·æ³¨å†Œ</button>
        <button class="tab" data-tab="password">ğŸ”‘ ä¿®æ”¹å¯†ç </button>
        <button class="tab" data-tab="email">ğŸ“§ ä¿®æ”¹é‚®ç®±</button>
        <button class="tab" data-tab="totp">ğŸ›¡ï¸ äºŒæ¬¡éªŒè¯</button>
    </div>

    <!-- ç”¨æˆ·æ³¨å†Œ TAB -->
    <div class="tab-content active" id="tab-register">
        <div class="section">
            <div class="section-title">ç”¨æˆ·æ³¨å†Œ</div>
            <div class="form-group">
                <label class="form-label">é‚®ç®±åœ°å€</label>
                <input id="registerEmail" type="email" class="form-input" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label class="form-label">ç™»å½•å¯†ç </label>
                <input id="registerPassword" type="password" class="form-input" placeholder="è¯·è®¾ç½®ä¸€ä¸ªå¼ºå¯†ç ">
            </div>
            <div class="form-group">
                <label class="form-label">ç¡®è®¤å¯†ç </label>
                <input id="registerPasswordConfirm" type="password" class="form-input" placeholder="å†æ¬¡è¾“å…¥è¿™ä¸ªå¯†ç ">
            </div>
            <div class="form-group">
                <label class="form-label">å¯†ç æç¤ºï¼ˆå¯é€‰ï¼‰</label>
                <input id="registerHint" type="text" class="form-input" placeholder="å¯†ç è¾…åŠ©æç¤ºçº¿ç´¢">
            </div>
            <br/><br/>
            <div class="info-box">
                ğŸ’¡ <strong>æ¸©é¦¨æç¤ºï¼š</strong>ä¸»å¯†ç æ˜¯è§£å¯†æ‰€æœ‰æ•°æ®çš„å”¯ä¸€å¯†é’¥ï¼Œè¯·åŠ¡å¿…ç‰¢è®°ã€‚<br/>
                ğŸ’¡ <strong>éšç§å£°æ˜ï¼š</strong>æœåŠ¡å™¨ä¸å­˜å‚¨æ˜æ–‡å¯†ç ï¼Œå¿˜è®°å¯†ç åå°†æ— æ³•æ‰¾å›ã€‚
            </div>
            <div class="btn-group">
                <a class="btn" href="#" id="registerSubmit">ç«‹å³æ³¨å†Œ</a>
            </div>
            <div id="registerResult" class="result"></div>
        </div>
        <div class="success-box" style="margin-top: 1.5rem;">
            <strong>â„¹ï¸ é‡è¦æé†’</strong><br>
            æ‰€æœ‰å¯†ç æ“ä½œå‡åœ¨æµè§ˆå™¨æœ¬åœ°å®Œæˆï¼ŒæœåŠ¡å™¨ä»…æ¥æ”¶åŠ å¯†åçš„æ•°æ®<br/>
            åœ¨è¿›è¡Œé‡è¦æ“ä½œå‰ï¼Œè¯·å…ˆå¯¼å‡ºå¤‡ä»½ï¼Œé¿å…æ•°æ®ä¸¢å¤±
        </div>
    </div>

    <!-- ä¿®æ”¹ä¸»å¯†ç  TAB -->
    <div class="tab-content" id="tab-password">
        <div class="section">
            <div class="section-title">ä¿®æ”¹å¯†ç </div>
            <div class="form-group">
                <label class="form-label">é‚®ç®±åœ°å€</label>
                <input id="email" type="email" class="form-input" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label class="form-label">å½“å‰å¯†ç </label>
                <input id="oldPassword" type="password" class="form-input" placeholder="è¯·è¾“å…¥å½“å‰ä¸»å¯†ç ">
            </div>
            <div class="form-group">
                <label class="form-label">æ–°çš„å¯†ç </label>
                <input id="newPassword" type="password" class="form-input" placeholder="è¯·è¾“å…¥æ–°çš„ä¸»å¯†ç ">
            </div>
            <div class="form-group">
                <label class="form-label">å¯†ç æç¤ºï¼ˆå¯é€‰ï¼‰</label>
                <input id="hint" type="text" class="form-input" placeholder="å¯†ç è¾…åŠ©æç¤ºçº¿ç´¢">
            </div>
            <br/><br/>
            <div class="info-box">
                ğŸ’¡ <strong>æ¸©é¦¨æç¤ºï¼š</strong>ä¸»å¯†ç æ˜¯è§£å¯†æ‰€æœ‰æ•°æ®çš„å”¯ä¸€å¯†é’¥ï¼Œè¯·åŠ¡å¿…ç‰¢è®°ã€‚<br/>
                ğŸ’¡ <strong>éšç§å£°æ˜ï¼š</strong>æœåŠ¡å™¨ä¸å­˜å‚¨æ˜æ–‡å¯†ç ï¼Œå¿˜è®°å¯†ç åå°†æ— æ³•æ‰¾å›ã€‚
            </div>
            <div class="btn-group">
                <a class="btn" href="#" id="submit">ç¡®è®¤ä¿®æ”¹</a>
            </div>
            <div id="result" class="result"></div>
        </div>

        <div class="success-box" style="margin-top: 1.5rem;">
            <strong>â„¹ï¸ é‡è¦æé†’</strong><br>
            æ‰€æœ‰å¯†ç æ“ä½œå‡åœ¨æµè§ˆå™¨æœ¬åœ°å®Œæˆï¼ŒæœåŠ¡å™¨ä»…æ¥æ”¶åŠ å¯†åçš„æ•°æ®<br/>
            åœ¨è¿›è¡Œé‡è¦æ“ä½œå‰ï¼Œè¯·å…ˆå¯¼å‡ºå¤‡ä»½ï¼Œé¿å…æ•°æ®ä¸¢å¤±
        </div>
    </div>

    <!-- ä¿®æ”¹é‚®ç®± TAB -->
    <div class="tab-content" id="tab-email">
        <div class="section">
            <div class="section-title">ä¿®æ”¹é‚®ç®±</div>
            <div class="form-group">
                <label class="form-label">å½“å‰é‚®ç®±</label>
                <input id="emailCurrent" type="email" class="form-input" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label class="form-label">æ–°é‚®ç®±</label>
                <input id="emailNew" type="email" class="form-input" placeholder="next@email.com">
            </div>
            <div class="form-group">
                <label class="form-label">ä¸»å¯†ç </label>
                <input id="emailPassword" type="password" class="form-input" placeholder="è¾“å…¥å¯†ç éªŒè¯èº«ä»½">
            </div>
            <br/><br/>
            <div class="info-box">
                ğŸ’¡ <strong>æ¸©é¦¨æç¤ºï¼š</strong>ä¸»å¯†ç æ˜¯è§£å¯†æ‰€æœ‰æ•°æ®çš„å”¯ä¸€å¯†é’¥ï¼Œè¯·åŠ¡å¿…ç‰¢è®°ã€‚<br/>
                ğŸ’¡ <strong>éšç§å£°æ˜ï¼š</strong>æœåŠ¡å™¨ä¸å­˜å‚¨æ˜æ–‡å¯†ç ï¼Œå¿˜è®°å¯†ç åå°†æ— æ³•æ‰¾å›ã€‚
            </div>
            <div class="btn-group">
                <a class="btn" href="#" id="submitEmail">ç¡®è®¤ä¿®æ”¹</a>
            </div>
            <div id="resultEmail" class="result"></div>
        </div>

        <div class="info-box" style="margin-top: 1.5rem;">
            ğŸ’¡ <strong>æç¤ºï¼š</strong>ä¿®æ”¹é‚®ç®±åï¼Œä¸»å¯†é’¥ä¼šä½¿ç”¨æ–°é‚®ç®±é‡æ–°æ´¾ç”Ÿã€‚<br/>
            è¯·ä½¿ç”¨æ–°é‚®ç®±ç™»å½• Bitwarden å®¢æˆ·ç«¯ã€‚
        </div>
    </div>

    <!-- äºŒæ¬¡éªŒè¯ TOTP TAB -->
    <div class="tab-content" id="tab-totp">
        <div class="section">
            <div class="section-title">ç™»å½•äºŒæ¬¡éªŒè¯ï¼ˆTOTPï¼‰</div>
            <div class="section-desc">å¯ç”¨åï¼Œç™»å½•æ—¶éœ€è¦è¾“å…¥åŠ¨æ€éªŒè¯ç ï¼Œæå‡è´¦æˆ·å®‰å…¨æ€§</div>

            <div class="form-group">
                <label class="form-label">é‚®ç®±åœ°å€</label>
                <input id="totpEmail" type="email" class="form-input" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label class="form-label">ä¸»å¯†ç </label>
                <input id="totpPassword" type="password" class="form-input" placeholder="è¾“å…¥ä¸»å¯†ç ">
            </div>

            <div class="btn-group">
                <a class="btn" href="#" id="totpRequest">ç”Ÿæˆå¯†é’¥</a>
            </div>

            <div class="form-group">
                <label class="form-label">å¯†é’¥ï¼ˆSecretï¼‰</label>
                <input id="totpSecret" type="text" class="form-input" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">OTP Auth URI</label>
                <textarea id="totpOtpauth" rows="3" class="form-textarea" readonly></textarea>
            </div>

            <div class="form-group">
                <label class="form-label">äºŒç»´ç </label>
                <div class="qr-container">
                    <img id="totpQr" alt="TOTP QR Code" class="qr-image">
                </div>
            </div>
            <br/><br/>
            <div class="info-box">
                ğŸ“± è¯·ä½¿ç”¨è®¤è¯å™¨ Appï¼ˆå¦‚ Google Authenticatorï¼‰æ‰«æäºŒç»´ç æˆ–æ‰‹åŠ¨è¾“å…¥å¯†é’¥
            </div>

            <div class="form-group">
                <label class="form-label">éªŒè¯ç </label>
                <input id="totpCode" type="text" class="form-input" placeholder="è¾“å…¥ 6 ä½éªŒè¯ç " maxlength="6">
            </div>

            <div class="btn-group">
                <a class="btn" href="#" id="totpEnable">å¯ç”¨éªŒè¯</a>
                <a class="btn btn-secondary" href="#" id="totpDisable">ç¦ç”¨éªŒè¯</a>
            </div>
            <div id="resultTotp" class="result"></div>
        </div>

        <div class="info-box" style="margin-top: 1.5rem;">
            ğŸ’¡ <strong>æç¤ºï¼š</strong>å¯ç”¨äºŒæ¬¡éªŒè¯åï¼Œæ¯æ¬¡ç™»å½•éƒ½éœ€è¦è¾“å…¥åŠ¨æ€éªŒè¯ç ã€‚<br/>
            è¯·å¦¥å–„ä¿ç®¡è®¤è¯å™¨ App ä¸­çš„å¯†é’¥ã€‚
        </div>
    </div>

    <div class="footer" style="color: #333333">
        Powered by <a href="https://github.com/PIKACHUIM/warden-worker">Warden Worker</a>
    </div>
</div>

<script>
    // TAB åˆ‡æ¢åŠŸèƒ½
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const targetTab = tab.getAttribute('data-tab');

            // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(tc => tc.classList.remove('active'));

            // æ·»åŠ æ´»åŠ¨çŠ¶æ€
            tab.classList.add('active');
            document.getElementById(`tab-${targetTab}`).classList.add('active');
        });
    });

    const registerSubmitBtn = document.getElementById('registerSubmit');
    const registerEmailInput = document.getElementById('registerEmail');
    const registerPasswordInput = document.getElementById('registerPassword');
    const registerPasswordConfirmInput = document.getElementById('registerPasswordConfirm');
    const registerHintInput = document.getElementById('registerHint');
    const registerResultEl = document.getElementById('registerResult');
    const submitBtn = document.getElementById('submit');
    const submitEmailBtn = document.getElementById('submitEmail');
    const emailInput = document.getElementById('email');
    const oldPasswordInput = document.getElementById('oldPassword');
    const newPasswordInput = document.getElementById('newPassword');
    const hintInput = document.getElementById('hint');
    const resultEl = document.getElementById('result');
    const emailCurrentInput = document.getElementById('emailCurrent');
    const emailNewInput = document.getElementById('emailNew');
    const emailPasswordInput = document.getElementById('emailPassword');
    const resultEmailEl = document.getElementById('resultEmail');
    const totpEmailInput = document.getElementById('totpEmail');
    const totpPasswordInput = document.getElementById('totpPassword');
    const totpRequestBtn = document.getElementById('totpRequest');
    const totpEnableBtn = document.getElementById('totpEnable');
    const totpDisableBtn = document.getElementById('totpDisable');
    const totpSecretInput = document.getElementById('totpSecret');
    const totpOtpauthInput = document.getElementById('totpOtpauth');
    const totpQrImg = document.getElementById('totpQr');
    const totpCodeInput = document.getElementById('totpCode');
    const resultTotpEl = document.getElementById('resultTotp');

    const encoder = new TextEncoder();

    function showResult(element, message, type = 'info') {
        element.textContent = message;
        element.className = 'result show';
        if (type === 'success') {
            element.style.background = '#d4edda';
            element.style.borderColor = '#28a745';
            element.style.color = '#155724';
        } else if (type === 'error') {
            element.style.background = '#f8d7da';
            element.style.borderColor = '#dc3545';
            element.style.color = '#721c24';
        } else {
            element.style.background = '#d1ecf1';
            element.style.borderColor = '#17a2b8';
            element.style.color = '#0c5460';
        }
    }

    function hideResult(element) {
        element.className = 'result';
    }

    function concatBytes(a, b) {
        const out = new Uint8Array(a.length + b.length);
        out.set(a, 0);
        out.set(b, a.length);
        return out;
    }

    function b64encode(bytes) {
        let binary = '';
        const chunkSize = 0x8000;
        for (let i = 0; i < bytes.length; i += chunkSize) {
            const chunk = bytes.subarray(i, i + chunkSize);
            binary += String.fromCharCode(...chunk);
        }
        return btoa(binary);
    }

    function b64decode(str) {
        const binary = atob(str);
        const out = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
            out[i] = binary.charCodeAt(i);
        }
        return out;
    }

    function pkcs7Pad(bytes, blockSize) {
        const padLen = blockSize - (bytes.length % blockSize);
        const out = new Uint8Array(bytes.length + padLen);
        out.set(bytes, 0);
        out.fill(padLen, bytes.length);
        return out;
    }

    function pkcs7Unpad(bytes) {
        if (bytes.length === 0) throw new Error('Invalid padding');
        const padLen = bytes[bytes.length - 1];
        if (padLen <= 0 || padLen > 16) throw new Error('Invalid padding');
        for (let i = bytes.length - padLen; i < bytes.length; i++) {
            if (bytes[i] !== padLen) throw new Error('Invalid padding');
        }
        return bytes.subarray(0, bytes.length - padLen);
    }

    async function pbkdf2Sha256(passwordBytes, saltBytes, iterations, lengthBytes) {
        const keyMaterial = await crypto.subtle.importKey(
            'raw',
            passwordBytes,
            'PBKDF2',
            false,
            ['deriveBits']
        );
        const bits = await crypto.subtle.deriveBits(
            {
                name: 'PBKDF2',
                salt: saltBytes,
                iterations,
                hash: 'SHA-256'
            },
            keyMaterial,
            lengthBytes * 8
        );
        return new Uint8Array(bits);
    }

    async function hkdfExpandSha256(prkBytes, infoBytes, lengthBytes) {
        if (lengthBytes > 32) {
            throw new Error('HKDF-Expand length too large for this implementation');
        }
        const infoWithCounter = concatBytes(infoBytes, new Uint8Array([1]));
        const okm = await hmacSha256(prkBytes, infoWithCounter);
        return okm.subarray(0, lengthBytes);
    }

    async function stretchMasterKey(masterKeyBytes) {
        const encKey = await hkdfExpandSha256(masterKeyBytes, encoder.encode('enc'), 32);
        const macKey = await hkdfExpandSha256(masterKeyBytes, encoder.encode('mac'), 32);
        return {encKey, macKey};
    }

    async function hmacSha256(macKeyBytes, dataBytes) {
        const key = await crypto.subtle.importKey(
            'raw',
            macKeyBytes,
            {name: 'HMAC', hash: 'SHA-256'},
            false,
            ['sign', 'verify']
        );
        const sig = await crypto.subtle.sign('HMAC', key, dataBytes);
        return new Uint8Array(sig);
    }

    async function hmacVerifySha256(macKeyBytes, dataBytes, signatureBytes) {
        const key = await crypto.subtle.importKey(
            'raw',
            macKeyBytes,
            {name: 'HMAC', hash: 'SHA-256'},
            false,
            ['verify']
        );
        return await crypto.subtle.verify('HMAC', key, signatureBytes, dataBytes);
    }

    async function aesCbcEncrypt(encKeyBytes, ivBytes, plainBytes) {
        const key = await crypto.subtle.importKey('raw', encKeyBytes, {name: 'AES-CBC'}, false, ['encrypt']);
        const ct = await crypto.subtle.encrypt({name: 'AES-CBC', iv: ivBytes}, key, plainBytes);
        return new Uint8Array(ct);
    }

    async function aesCbcDecrypt(encKeyBytes, ivBytes, cipherBytes) {
        const key = await crypto.subtle.importKey('raw', encKeyBytes, {name: 'AES-CBC'}, false, ['decrypt']);
        const pt = await crypto.subtle.decrypt({name: 'AES-CBC', iv: ivBytes}, key, cipherBytes);
        return new Uint8Array(pt);
    }

    async function decryptEncString(encString, encKeyBytes, macKeyBytes) {
        const parts = encString.split('.', 2);
        if (parts.length !== 2) throw new Error('Invalid encString');
        const encType = parts[0];
        if (encType !== '2') throw new Error(`Unsupported encType: ${encType}`);
        const payload = parts[1].split('|');
        if (payload.length !== 3) throw new Error('Invalid encString payload');
        const iv = b64decode(payload[0]);
        const ct = b64decode(payload[1]);
        const mac = b64decode(payload[2]);
        const dataToMac = concatBytes(iv, ct);
        const ok = await hmacVerifySha256(macKeyBytes, dataToMac, mac);
        if (!ok) throw new Error('MAC æ ¡éªŒå¤±è´¥ï¼ˆæ—§ä¸»å¯†ç å¯èƒ½ä¸æ­£ç¡®ï¼‰');
        const raw = await aesCbcDecrypt(encKeyBytes, iv, ct);
        try {
            return {
                plainBytes: pkcs7Unpad(raw),
                usedPadding: true,
                ivLen: iv.length,
                ctLen: ct.length,
                macLen: mac.length
            };
        } catch {
            return {plainBytes: raw, usedPadding: false, ivLen: iv.length, ctLen: ct.length, macLen: mac.length};
        }
    }

    async function encryptEncString(plainBytes, encKeyBytes, macKeyBytes, usePadding) {
        const iv = crypto.getRandomValues(new Uint8Array(16));
        const input = usePadding ? pkcs7Pad(plainBytes, 16) : plainBytes;
        const ct = await aesCbcEncrypt(encKeyBytes, iv, input);
        const mac = await hmacSha256(macKeyBytes, concatBytes(iv, ct));
        return `2.${b64encode(iv)}|${b64encode(ct)}|${b64encode(mac)}`;
    }

    async function deriveMasterKey(email, password, kdfIterations) {
        const salt = encoder.encode(email.toLowerCase());
        const pw = encoder.encode(password);
        return await pbkdf2Sha256(pw, salt, kdfIterations, 32);
    }

    async function deriveMasterPasswordHash(masterKeyBytes, password) {
        const pw = encoder.encode(password);
        const hash = await pbkdf2Sha256(masterKeyBytes, pw, 1, 32);
        return b64encode(hash);
    }

    async function prelogin(email) {
        const preloginResp = await fetch('/identity/accounts/prelogin', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email})
        });
        const preloginText = await preloginResp.text();
        if (!preloginResp.ok) {
            throw new Error(`prelogin å¤±è´¥ HTTP ${preloginResp.status}\n${preloginText}`);
        }
        const preloginJson = JSON.parse(preloginText);
        return preloginJson.kdfIterations;
    }

    async function login(email, masterPasswordHash) {
        const form = new URLSearchParams();
        form.set('grant_type', 'password');
        form.set('username', email);
        form.set('password', masterPasswordHash);
        const tokenResp = await fetch('/identity/connect/token', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: form.toString()
        });
        const tokenText = await tokenResp.text();
        if (!tokenResp.ok) {
            throw new Error(`ç™»å½•å¤±è´¥ HTTP ${tokenResp.status}\n${tokenText}`);
        }
        return JSON.parse(tokenText);
    }

    // ç”¨æˆ·æ³¨å†Œ
    registerSubmitBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        hideResult(registerResultEl);

        try {
            const email = registerEmailInput.value.trim();
            const password = registerPasswordInput.value;
            const passwordConfirm = registerPasswordConfirmInput.value;
            const hint = registerHintInput.value.trim();

            if (!email || !password || !passwordConfirm) {
                showResult(registerResultEl, 'âŒ è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹', 'error');
                return;
            }

            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showResult(registerResultEl, 'âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€', 'error');
                return;
            }

            if (password.length < 8) {
                showResult(registerResultEl, 'âŒ ä¸»å¯†ç é•¿åº¦è‡³å°‘ä¸º 8 ä½', 'error');
                return;
            }

            if (password !== passwordConfirm) {
                showResult(registerResultEl, 'âŒ ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }

            showResult(registerResultEl, 'â³ æ­£åœ¨ç”ŸæˆåŠ å¯†å¯†é’¥...', 'info');

            // é»˜è®¤ KDF è¿­ä»£æ¬¡æ•°
            const kdfIterations = 600000;

            // æ´¾ç”Ÿä¸»å¯†é’¥
            const masterKey = await deriveMasterKey(email, password, kdfIterations);
            const masterPasswordHash = await deriveMasterPasswordHash(masterKey, password);

            // ç”Ÿæˆç”¨æˆ·å¯¹ç§°å¯†é’¥
            const symmetricKey = crypto.getRandomValues(new Uint8Array(64));
            const stretched = await stretchMasterKey(masterKey);
            const protectedSymmetricKey = await encryptEncString(
                symmetricKey,
                stretched.encKey,
                stretched.macKey,
                true
            );

            showResult(registerResultEl, 'â³ æ­£åœ¨åˆ›å»ºè´¦æˆ·...', 'info');

            // è°ƒç”¨æ³¨å†Œ API
            const registerResp = await fetch('/identity/accounts/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    email: email,
                    masterPasswordHash: masterPasswordHash,
                    masterPasswordHint: hint || null,
                    key: protectedSymmetricKey,
                    kdf: 0,
                    kdfIterations: kdfIterations
                })
            });

            const registerText = await registerResp.text();
            if (!registerResp.ok) {
                showResult(registerResultEl, `âŒ æ³¨å†Œå¤±è´¥ HTTP ${registerResp.status}\n${registerText}`, 'error');
                return;
            }

            showResult(registerResultEl, 'âœ… æ³¨å†ŒæˆåŠŸï¼ä½ ç°åœ¨å¯ä»¥ä½¿ç”¨ Bitwarden å®¢æˆ·ç«¯ç™»å½•äº†ã€‚\n\nğŸ“§ é‚®ç®±ï¼š' + email + '\nğŸ”‘ è¯·ç‰¢è®°ä½ çš„ä¸»å¯†ç ï¼ŒæœåŠ¡å™¨ä¸å­˜å‚¨æ˜æ–‡å¯†ç ã€‚', 'success');

            // æ¸…ç©ºè¡¨å•
            registerEmailInput.value = '';
            registerPasswordInput.value = '';
            registerPasswordConfirmInput.value = '';
            registerHintInput.value = '';
        } catch (err) {
            showResult(registerResultEl, 'âŒ ' + String(err), 'error');
        }
    });

    // ä¿®æ”¹ä¸»å¯†ç 

    // ä¿®æ”¹ä¸»å¯†ç 
    submitBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        hideResult(resultEl);

        try {
            const email = emailInput.value.trim();
            const oldPassword = oldPasswordInput.value;
            const newPassword = newPasswordInput.value;
            const hint = hintInput.value.trim();

            if (!email || !oldPassword || !newPassword) {
                showResult(resultEl, 'âŒ è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹', 'error');
                return;
            }
            if (oldPassword === newPassword) {
                showResult(resultEl, 'âŒ æ–°æ—§ä¸»å¯†ç ä¸èƒ½ç›¸åŒ', 'error');
                return;
            }

            showResult(resultEl, 'â³ æ­£åœ¨è¯»å– KDF å‚æ•°...', 'info');
            const kdfIterations = await prelogin(email);

            showResult(resultEl, 'â³ æ­£åœ¨éªŒè¯æ—§å¯†ç å¹¶ç™»å½•...', 'info');
            const oldMasterKey = await deriveMasterKey(email, oldPassword, kdfIterations);
            const oldMasterPasswordHash = await deriveMasterPasswordHash(oldMasterKey, oldPassword);

            const tokenJson = await login(email, oldMasterPasswordHash);
            const accessToken = tokenJson.access_token;
            const protectedSymmetricKey = tokenJson.Key;

            showResult(resultEl, 'â³ æ­£åœ¨é‡æ–°åŠ å¯†ç”¨æˆ·å¯†é’¥...', 'info');
            const oldStretched = await stretchMasterKey(oldMasterKey);
            const decrypted = await decryptEncString(protectedSymmetricKey, oldStretched.encKey, oldStretched.macKey);
            const symmetricKeyPlain = decrypted.plainBytes;

            const newMasterKey = await deriveMasterKey(email, newPassword, kdfIterations);
            const newMasterPasswordHash = await deriveMasterPasswordHash(newMasterKey, newPassword);
            const newStretched = await stretchMasterKey(newMasterKey);
            const newProtectedSymmetricKey = await encryptEncString(
                symmetricKeyPlain,
                newStretched.encKey,
                newStretched.macKey,
                decrypted.usedPadding
            );

            showResult(resultEl, 'â³ æ­£åœ¨æäº¤ä¿®æ”¹...', 'info');
            const changeResp = await fetch('/api/accounts/password', {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    masterPasswordHash: oldMasterPasswordHash,
                    newMasterPasswordHash: newMasterPasswordHash,
                    masterPasswordHint: hint ? hint : null,
                    userSymmetricKey: newProtectedSymmetricKey,
                    kdf: 0,
                    kdfIterations: kdfIterations
                })
            });
            const changeText = await changeResp.text();
            if (!changeResp.ok) {
                showResult(resultEl, `âŒ ä¿®æ”¹å¤±è´¥ HTTP ${changeResp.status}\n${changeText}`, 'error');
                return;
            }

            showResult(resultEl, `âœ… ä¸»å¯†ç ä¿®æ”¹æˆåŠŸï¼\n\nè¯·åœ¨ Bitwarden å®¢æˆ·ç«¯ä½¿ç”¨æ–°å¯†ç é‡æ–°ç™»å½•ã€‚\n\nğŸ” åŠ å¯†ä¿¡æ¯ï¼šiv=${decrypted.ivLen} ct=${decrypted.ctLen} mac=${decrypted.macLen} padding=${decrypted.usedPadding ? 'pkcs7' : 'none'}`, 'success');

            // æ¸…ç©ºå¯†ç å­—æ®µ
            oldPasswordInput.value = '';
            newPasswordInput.value = '';
        } catch (err) {
            showResult(resultEl, 'âŒ ' + String(err), 'error');
        }
    });

    // ä¿®æ”¹é‚®ç®±
    submitEmailBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        hideResult(resultEmailEl);

        try {
            const emailCurrent = emailCurrentInput.value.trim();
            const emailNew = emailNewInput.value.trim();
            const password = emailPasswordInput.value;

            if (!emailCurrent || !emailNew || !password) {
                showResult(resultEmailEl, 'âŒ è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹', 'error');
                return;
            }
            if (emailCurrent.toLowerCase() === emailNew.toLowerCase()) {
                showResult(resultEmailEl, 'âŒ æ–°æ—§é‚®ç®±ä¸èƒ½ç›¸åŒ', 'error');
                return;
            }

            showResult(resultEmailEl, 'â³ æ­£åœ¨è¯»å– KDF å‚æ•°...', 'info');
            const kdfIterations = await prelogin(emailCurrent);

            showResult(resultEmailEl, 'â³ æ­£åœ¨éªŒè¯èº«ä»½å¹¶ç™»å½•...', 'info');
            const oldMasterKey = await deriveMasterKey(emailCurrent, password, kdfIterations);
            const oldMasterPasswordHash = await deriveMasterPasswordHash(oldMasterKey, password);
            const tokenJson = await login(emailCurrent, oldMasterPasswordHash);
            const accessToken = tokenJson.access_token;
            const protectedSymmetricKey = tokenJson.Key;

            showResult(resultEmailEl, 'â³ æ­£åœ¨é‡æ–°åŠ å¯†ç”¨æˆ·å¯†é’¥...', 'info');
            const oldStretched = await stretchMasterKey(oldMasterKey);
            const decrypted = await decryptEncString(protectedSymmetricKey, oldStretched.encKey, oldStretched.macKey);
            const symmetricKeyPlain = decrypted.plainBytes;

            const newMasterKey = await deriveMasterKey(emailNew, password, kdfIterations);
            const newMasterPasswordHash = await deriveMasterPasswordHash(newMasterKey, password);
            const newStretched = await stretchMasterKey(newMasterKey);
            const newProtectedSymmetricKey = await encryptEncString(
                symmetricKeyPlain,
                newStretched.encKey,
                newStretched.macKey,
                decrypted.usedPadding
            );

            showResult(resultEmailEl, 'â³ æ­£åœ¨æäº¤ä¿®æ”¹...', 'info');
            const changeResp = await fetch('/api/accounts/email', {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    masterPasswordHash: oldMasterPasswordHash,
                    newMasterPasswordHash: newMasterPasswordHash,
                    newEmail: emailNew,
                    userSymmetricKey: newProtectedSymmetricKey,
                    kdf: 0,
                    kdfIterations: kdfIterations
                })
            });
            const changeText = await changeResp.text();
            if (!changeResp.ok) {
                showResult(resultEmailEl, `âŒ ä¿®æ”¹å¤±è´¥ HTTP ${changeResp.status}\n${changeText}`, 'error');
                return;
            }

            showResult(resultEmailEl, `âœ… é‚®ç®±ä¿®æ”¹æˆåŠŸï¼\n\nè¯·ä½¿ç”¨æ–°é‚®ç®±é‡æ–°ç™»å½• Bitwarden å®¢æˆ·ç«¯ã€‚\n\nğŸ“§ æ–°é‚®ç®±ï¼š${emailNew}\nğŸ” åŠ å¯†ä¿¡æ¯ï¼šiv=${decrypted.ivLen} ct=${decrypted.ctLen} mac=${decrypted.macLen} padding=${decrypted.usedPadding ? 'pkcs7' : 'none'}`, 'success');

            // æ¸…ç©ºè¡¨å•
            emailCurrentInput.value = '';
            emailNewInput.value = '';
            emailPasswordInput.value = '';
        } catch (err) {
            showResult(resultEmailEl, 'âŒ ' + String(err), 'error');
        }
    });


    let totpAccessToken = null;

    // TOTP ç”Ÿæˆå¯†é’¥
    totpRequestBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        hideResult(resultTotpEl);
        totpSecretInput.value = '';
        totpOtpauthInput.value = '';
        totpQrImg.removeAttribute('src');
        totpAccessToken = null;

        try {
            const email = totpEmailInput.value.trim();
            const password = totpPasswordInput.value;
            if (!email || !password) {
                showResult(resultTotpEl, 'âŒ è¯·å¡«å†™é‚®ç®±ä¸ä¸»å¯†ç ', 'error');
                return;
            }

            showResult(resultTotpEl, 'â³ æ­£åœ¨è¯»å– KDF å‚æ•°...', 'info');
            const kdfIterations = await prelogin(email);
            const masterKey = await deriveMasterKey(email, password, kdfIterations);
            const masterPasswordHash = await deriveMasterPasswordHash(masterKey, password);

            showResult(resultTotpEl, 'â³ æ­£åœ¨ç™»å½•è·å–æˆæƒ...', 'info');
            const tokenJson = await login(email, masterPasswordHash);
            totpAccessToken = tokenJson.access_token;

            showResult(resultTotpEl, 'â³ æ­£åœ¨ç”Ÿæˆ TOTP å¯†é’¥...', 'info');
            const resp = await fetch('/api/two-factor/authenticator/request', {
                method: 'POST',
                headers: {'Authorization': `Bearer ${totpAccessToken}`}
            });
            const text = await resp.text();
            if (!resp.ok) {
                showResult(resultTotpEl, `âŒ è¯·æ±‚å¤±è´¥ HTTP ${resp.status}\n${text}`, 'error');
                return;
            }
            const data = JSON.parse(text);
            totpSecretInput.value = data.secret || '';
            totpOtpauthInput.value = data.otpauth || '';
            if (data.qrBase64) {
                totpQrImg.setAttribute('src', `data:image/png;base64,${data.qrBase64}`);
            } else {
                totpQrImg.removeAttribute('src');
            }
            showResult(resultTotpEl, 'âœ… å¯†é’¥å·²ç”Ÿæˆï¼\n\nè¯·åœ¨è®¤è¯å™¨ App ä¸­æ·»åŠ åï¼Œè¾“å…¥éªŒè¯ç å¹¶ç‚¹å‡»"å¯ç”¨éªŒè¯"ã€‚', 'success');
        } catch (err) {
            showResult(resultTotpEl, 'âŒ ' + String(err), 'error');
        }
    });

    // TOTP å¯ç”¨
    totpEnableBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        hideResult(resultTotpEl);

        try {
            if (!totpAccessToken) {
                showResult(resultTotpEl, 'âŒ è¯·å…ˆç‚¹å‡»"ç”Ÿæˆå¯†é’¥"æŒ‰é’®', 'error');
                return;
            }
            const code = totpCodeInput.value.trim();
            if (!code) {
                showResult(resultTotpEl, 'âŒ è¯·è¾“å…¥ 6 ä½éªŒè¯ç ', 'error');
                return;
            }

            showResult(resultTotpEl, 'â³ æ­£åœ¨å¯ç”¨äºŒæ¬¡éªŒè¯...', 'info');
            const resp = await fetch('/api/two-factor/authenticator/enable', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${totpAccessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({code})
            });
            const text = await resp.text();
            if (!resp.ok) {
                showResult(resultTotpEl, `âŒ å¯ç”¨å¤±è´¥ HTTP ${resp.status}\n${text}`, 'error');
                return;
            }
            showResult(resultTotpEl, 'âœ… äºŒæ¬¡éªŒè¯å·²å¯ç”¨ï¼\n\nä¹‹åç™»å½• Bitwarden å®¢æˆ·ç«¯æ—¶éœ€è¦è¾“å…¥åŠ¨æ€éªŒè¯ç ã€‚', 'success');
            totpCodeInput.value = '';
        } catch (err) {
            showResult(resultTotpEl, 'âŒ ' + String(err), 'error');
        }
    });

    // TOTP ç¦ç”¨
    totpDisableBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        hideResult(resultTotpEl);

        try {
            if (!totpAccessToken) {
                showResult(resultTotpEl, 'âŒ è¯·å…ˆå¡«å†™é‚®ç®±ä¸ä¸»å¯†ç å¹¶ç‚¹å‡»"ç”Ÿæˆå¯†é’¥"è·å–æˆæƒ', 'error');
                return;
            }
            const code = totpCodeInput.value.trim();
            if (!code) {
                showResult(resultTotpEl, 'âŒ è¯·è¾“å…¥ 6 ä½éªŒè¯ç ', 'error');
                return;
            }

            showResult(resultTotpEl, 'â³ æ­£åœ¨ç¦ç”¨äºŒæ¬¡éªŒè¯...', 'info');
            const resp = await fetch('/api/two-factor/authenticator/disable', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${totpAccessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({code})
            });
            const text = await resp.text();
            if (!resp.ok) {
                showResult(resultTotpEl, `âŒ ç¦ç”¨å¤±è´¥ HTTP ${resp.status}\n${text}`, 'error');
                return;
            }
            showResult(resultTotpEl, 'âœ… äºŒæ¬¡éªŒè¯å·²ç¦ç”¨ï¼', 'success');
            totpCodeInput.value = '';
        } catch (err) {
            showResult(resultTotpEl, 'âŒ ' + String(err), 'error');
        }
    });
</script>
</body>
</html>
